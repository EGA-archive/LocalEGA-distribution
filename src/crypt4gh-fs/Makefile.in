
CC       = @CC@
CPPFLAGS = -I@srcdir@ -fPIC
CFLAGS   = @CFLAGS@ @CPPFLAGS@ @DEFS@ @DEBUG@
LIBS     = @LIBS@
LDFLAGS  = @LDFLAGS@

prefix=@prefix@
exec_prefix=@exec_prefix@
bindir = @bindir@

OBJS = fs.o cache.o db.o pool.o readconf.o main.o

.PHONY: ega-dist-fs

all: ega-dist-fs

$(bindir):
	mkdir -p $@

ega-dist-fs: $(OBJS)
	@$(CC) -o $@ $(OBJS) $(LDFLAGS) $(LIBS)

.c.o:
	@echo "Compiling $<"
	@$(CC) $(CPPFLAGS) $(CFLAGS) -c -o $@ $<

install: ega-dist-fs | $(bindir)
	@echo "Installing $< into $(bindir)"
	@install -m 755 $< $(bindir)

clean:
	-rm -f $(OBJS) ega-dist-fs
	-@rm -f *~ 

distclean: clean
	-rm -f Makefile config.h* config.status configure config.log
	-rm -rf autom4te.cache .depend.old


###################################
## Testing
###################################

#USER=jordi.rambla\@crg.eu
USER=silverdaz
#USER=laia.codo\@bsc.es


unmount run: UID=$(shell id -u $(USER))
run: GID=$(shell id -g $(USER))
run: ega-dist-fs
	exec 7</etc/ega/fs-c.conf; setpriv --ruid $(UID) \
		--rgid $(GID) \
		--init-groups \
		-- \
	./$< --conf 7 -o ro,default_permissions,allow_root,fsname=EGADistFS /home/$(UID)/outbox

unmount:
	-umount /home/$(UID)/outbox

rerun: unmount ega-dist-fs run


###################################
## Dependencies
###################################
depend: depend-rebuild
	rm -f .depend.bak

depend-rebuild:
	mv .depend .depend.old
	rm -f config.h .depend
	touch config.h .depend
	makedepend -w1000 -I@srcdir@ @DEFS@ -f .depend *.c 2>/dev/null
	(echo '# Automatically generated by makedepend.'; \
	 echo '# Run "make depend" to rebuild.'; sort .depend ) > .depend.tmp
	mv .depend.tmp .depend
	rm -f .depend.bak
	mv .depend.old .depend.bak

depend-check: depend-rebuild
	cmp .depend .depend.bak || (echo .depend stale && exit 1)

# @DEPEND@
